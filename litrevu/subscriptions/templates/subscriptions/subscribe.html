{% extends 'subscriptions/base.html' %}

{% block content %}
<div class="form-container">
    <div class="form-group">
        <h2>Suivre d'autres utilisateurs</h2>
        <form action="{% url 'subscribe' %}" method="post">
            {% csrf_token %}
            <input type="text" id="user_to_follow" name="user_to_follow" placeholder="Entrez le nom d'utilisateur"
                required autocomplete="off">
            <ul id="suggestions" style="list-style-type: none; display: none;"></ul>

            <button type="submit" class="btn">Suivre</button>
        </form>

        {% if messages %}
        <ul class="messages">
            {% for message in messages %}
            <li {% if message.tags %}class="{{ message.tags }}" {% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <div class="separator"></div>

    <h2>Abonnements</h2>
    <div class="subscription-list">
        {% for follow in followed_users %}
        <div class="form-group">
            <span>{{ follow.followed_user.username }}</span>
            <form action="{% url 'subscribe' %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="unfollow_user_id" value="{{ follow.followed_user.id }}">
                <button type="submit" class="btn">Ne plus suivre</button>
            </form>
        </div>
        {% empty %}
        <p>Vous ne suivez personne pour le moment.</p>
        {% endfor %}
    </div>

    <div class="separator"></div>

    <h2>Abonn√©s</h2>
    <div class="followers-list">
        {% for follower in followers %}
        <div class="form-group">
            <span>{{ follower.user.username }}</span>
        </div>
        {% empty %}
        <p>Aucun utilisateur ne vous suit pour le moment.</p>
        {% endfor %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const inputField = document.querySelector('#user_to_follow');
        inputField.addEventListener('input', function (e) {
            const searchTerm = e.target.value;
            if (searchTerm.length > 0) {
                fetch(`{% url 'subscribe' %}?term=${searchTerm}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        updateSuggestions(data);
                    })
                    .catch(error => console.error('Error:', error));
            } else {
                updateSuggestions([]);
            }
        });

        function updateSuggestions(users) {
            const suggestions = document.querySelector('#suggestions');
            suggestions.innerHTML = '';
            users.forEach(user => {
                const suggestionElement = document.createElement('li');
                suggestionElement.textContent = user;
                suggestionElement.addEventListener('click', function () {
                    inputField.value = user;
                    suggestions.style.display = 'none';
                });
                suggestions.appendChild(suggestionElement);
            });
            suggestions.style.display = users.length > 0 ? 'block' : 'none';
        }
    });
</script>
{% endblock %}